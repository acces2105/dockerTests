##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

#############################################################################
# main server config для обращения к приложению через индексФайл приложения 
#############################################################################
#блок server и тело {}


server {
	listen 80;
	server_name localhost;
    ################################################
    # SSL configuration
    ################################################
    # main https start
    ################################################
    # Данный блок запускает настройки SSL для HttpS
	################################################
	#listen 443 ssl default_server;
	#listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#

    #listen 443 ssl;
	#listen [::]:443 ssl;
	
	# новый ip 195.239.151.85
	server_name 195.239.151.85;
    #старый ip server_name runall.ru 77.41.148.125;
	
	#
    #include /var/www/html/php_project09082023/config/nginx/snippets/main_snakeoil.conf;
    #include snippets/snakeoil.conf;
    #main https end
###############################################################################

    #до 05042025 только для http
	
    charset utf-8;                               #кодировка
    client_max_body_size 128M;
	
	# подключение логирования
	#debug: сообщения, используемые для отладки.
	#info: информационные сообщения.
	#notice: произошло примечательное событие.
	#warn: произошло что-то неожиданное.
	#error: что-то не удалось.
	#crit: критические состояния.
	#alert: ошибки, требующие немедленных действий.
	#emerg: система непригодна для использования.
	
	#журналы логирования по умолчанию
	#журнал доступа
	#access_log /etc/nginx/logs/access.log;
	#access_log  /var/log/nginx/$host.access.log;
	#access_log  /var/log/nginx/runall/$host.access.log;
	#журнал ошибок
	#error_log  /etc/nginx/logs/error.log;
	#error_log   /var/log/nginx/error.log debug;
	#error_log   /var/log/nginx/runall/error.log debug;
	
	#журнал в формате json
	#log_format json_combined escape=json
	#'{'
    #'"time_local":"$time_local",'
    #'"remote_addr":"$remote_addr",'
    #'"remote_user":"$remote_user",'
    #'"request":"$request",'
    #'"status": "$status",'
    #'"body_bytes_sent":"$body_bytes_sent",'
    #'"http_referrer":"$http_referer",'
    #'"http_user_agent":"$http_user_agent",'
    #'"request_time":"$request_time"'
	#'}';
	#access_log  /var/log/nginx/$host.access.log json_combined;
	
	# полный запрет на передачу контента
	#deny all;
    #return 403;
	#types {
	#	php;
	#}

	#переопределяет индексный файл по умолчанию
	#index index.php;
	#"root" Задаёт корневой каталог для запросов в блоке сервер при обращении в корень URI\
	#old_root /var/www/html/php_project09082023;
	root /var/www/nginx/projects/projects_php;
	#root /usr/share/;
	#try_files $uri =404;
	#задает имя сервера 
	#server_name localhost;

	##############
    #main settings
    ##############
	#directive echo module 
    #echo_location_async_sleep_time 2;
	
	# / здесь мсамый короткий префикс (/). Если есть совпадение с несколькими блоками location,
	# по умолчанию nginx выбирает блок с самым длинным префиксом, т.е. если есть длиннее. 
		location / {
		index index.php index.htm;
		#root /var/www/html/php_project09082023;
        try_files $uri $uri/ /index.php?$query_string;
		#echo "Добро пожаловать на наш сайт!";
		#set $foo hello;
        #echo "foo: $foo";
		}
		 
    location ~ \.(php|htm)$ {
		# заголовки CORS
		#add_header 'Access-Control-Allow-Origin' '*';
  		#add_header 'Access-Control-Allow-Methods' 'GET, POST';
		# заголовки CORS
		#"root" Задаёт корневой каталог для запросов
		#old_root /var/www/html/php_project09082023;
		root /var/www/nginx/projects/projects_php;
		try_files $uri uri/ /index.htm $uri =404;
		#try_files $uri $uri/ /index.php?$query_string;
		#(fastcgi_pass) - определяет что FastCGI-сервер доступен по адресу:
        #fastcgi_pass  localhost:9000; или:
        #fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
		fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
		#переменная fastcgi_index задаёт имя файла, который при создании переменной $fastcgi_script_name
		#будет добавляться после URI, если URI заканчивается слэшом. Настраивается здесь либо в include snippets/fastcgi-php.conf;
		#fastcgi_index index.php;
		#"fastcgi_param" для настройки параметров, передаваемых FastCGI-серверу
		#"SCRIPT_FILENAME" используется для определения имени скрипта
		#переменная $document_root - значение директивы root или alias для текущего запроса
		#переменная $fastcgi_script_name URI запроса или же, если URI заканчивается слэшом,
		#то URI запроса, дополненное именем индексного файла, задаваемого директивой fastcgi_index.
		#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		#в QUERY_STRING передаются параметры запроса
		#fastcgi_param QUERY_STRING    $query_string;
        #try_files $uri $uri/ /index.php?$args;
		# "include" подключает файл с парамтрами.
		# Этот файл содержит список определений переменных, необходимых для php7.*-fpm.
		#Переменные определяются напрямую или посредством включения отдельного файла расположенного по /etc/nginx/fastcgi.conf
	#	include /etc/nginx/conf/fastcgi.conf;
	#	include /etc/nginx/conf/fastcgi.conf;
		include /snippets/fastcgi-php.conf;
		#include snippets/snakeoil.conf; SSl
		#include the fastcgi_param setting
   		include fastcgi_params;
    }
	# префиксный loc для раздачи изображений
	# location = /public/ {   
    #root /var/www/html/php_project09082023;
	#}  
	# loc через рег выражение
	location ^~ \.(png|ico|gif|jpg|jpeg)$ {  
    root /var/www/html/php_project09082023/public/public_images;
	#Директива location для Anti-hotlinking (борьбы с использованием ресурсов с вашего сервера на сторонних ресурсах).
	#https://itzx.ru/linux/derektiva-nginx-location-s-primerami
	valid_referers none blocked mywebsite.com *.mywebsite.com;
    if ($invalid_referer) {
       return 403;
    }
	}
	# далее идет префикс /phpmyadmin/ , который длиннее чем префикс (/). Если есть совпадение с несколькими блоками location,
	# по умолчанию nginx выбирает блок с самым длинным префиксом, т.е. если есть длиннее.
	#блок locatoin и тело {}
	location = /phpmyadmin/ {
	##		root /usr/share/phpmyadmin/;
			#root /var/www/html/php_project09082023;
			index index.php;
			#try_files $uri =404;
	##		try_files $uri $uri/ /phpmyadmin/ /index.php?$query_string;
			#allow 127.0.0.1;
            #allow ::1;
            #deny all;
	##		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			# QUERY_STRING передаются параметры запроса
	##		fastcgi_param QUERY_STRING $query_string;
    ##        include snippets/fastcgi-php.conf;
    ##        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
	##		include fastcgi_params;
	##		deny all;
    ##    	return 403;
	##		types {
	##		default_type php;
	##	}
    }

	location = /tests_and_help/ {
		index index.php index.htm index.html;
		#try_files $uri uri/ /index.php?is_args$args;
		try_files $uri $uri/*.php?$query_string $uri/*.php?is_args$args $uri/ /basa.php?$query_string;
		#include fastcgi_params;
	}

	location = /var/www/html/mobileIncomerise24042025 {
		index index.php index.htm index.html index.js index.njs;
		#try_files $uri uri/ /index.php?is_args$args;
		#try_files $uri $uri/*.js?$query_string; 
		#$uri/*.php?$query_string $uri/*.php?is_args$args $uri/ /basa.php?$query_string;
		#try_files $uri $uri/*.php?$query_string $uri/*.php?is_args$args $uri/ /basa.php?$query_string;
		#include fastcgi_params;
		#js_content index.hello;
	}

	#location ~ \.(js|mjs)$ {
    #    root /var/www/html/mobileIncomerise24042025;
    #}
	#location = /var/www/html/mobileIncomerise24042025 {
			#root /var/www/html/mobileIncomerise24042025;
    #        js_content index.hello;
    #    }

    ##location ~ \.(gif|jpg|png)$ {
    ##    root /data/images;
    ##}
	#location ~* /\. {
    #    deny all;
    #}

	###############################################
	# ОТЛАДОЧНЫЙ БЛОК NGINX
	###############################################
	##location /echo {
		#echo_duplicate yes;
		#echo_flush yes;
	##	try_files $uri /echo;
	##	root /var/www/html/php_project09082023;
	##		index index.php;
			#try_files $uri =404;
			#fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			# QUERY_STRING передаются параметры запроса
			#fastcgi_param QUERY_STRING $query_string;
            #include snippets/fastcgi-php.conf;
    ##        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
			#include fastcgi_params;
	##}

	##location /args/ {
	##			charset utf-8;
    ##            add_header Content-Type text/plain;
	##			try_files $uri /index.php?$query_string;
    ##            return 200 
			#"arg_name: $arg_name
			#
			# time_local: $time_local
			# nginx_version: $nginx_version
			# pid: $pid
			#
			# remote_addr: $remote_addr
			# server_port: $server_port
			# server_protocol: $server_protocol
			# server_name: $server_name
			# host: $host
			# status: $status
			# host_name: $hostname
			# http_name: $http_name
			# https: $https
			#
			# is_args (“?”, если в строке запроса есть аргументы, и пустая строка, если их нет): $is_args
			# document_root: $document_root
			# document_uri: $document_uri
			# uri:$uri
			# args: $args
			# query_string: $query_string
			# fastcgi_script_name: $fastcgi_script_name 
			#
			# request_method: $request_method
			# request: $request
			#
			# content_length: $content_length
			# content_type: $content_type";
        ##}
##############################################################
# СКОБКА КОНЦА БЛОКА SERVER
##############################################################  		
}

##############################################################
# Default server configuration
##############################################################
#server {
#	listen 80 default_server;
#	listen [::]:80 default_server;
	#########################################
	#Настройка перенаправления в блоке Server
	#########################################
	#return <404> http://$host$request_uri;	

	# SSL configuration
	#
#	listen 443 ssl default_server;
#	listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
#	include snippets/snakeoil.conf;

#	root /var/www/html/php_project09082023;

	# Add index.php to the list if you are using PHP
	#index;
#        index index.html index.htm index.nginx-debian.html index.main.html index.php test.php;

#	server_name _;
              
#	location ~ ^/(user)$ {
#       rewrite ^/(.*)$ /$1.php last; 
#	}
#        rewrite ^(/.+?)/?$ $1.php last;
#    	rewrite ^/(about|version)$ /$1.php last;
#    	rewrite ^/$ /index.php last;
#    	rewrite_log on;

#	location / {
		########################################
		#Настойка перенаправления на index.php
		########################################
		#index index.php;
		#try_files $uri $uri/ /index.php?$args;
                ########################################
                #Настойка перенаправления index без  php или html
                ########################################
#                try_files $uri $uri/ /index.php =404;
#                index index.html index.htm index.nginx-debian.html index.main.html index.php test.php; 
 		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		###try_files $uri $uri/ =404;
#	}

	# pass PHP scripts to FastCGI server
	#
	#########################################
        #Настойка перенаправления на index.php
        ########################################
	# location ~ [^/]\.php(/|$) {
	#	fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    	#	if (!-f $document_root$fastcgi_script_name) {
        #	return 404;
    	#}
    	########################################
        #Настойка перенаправления index без  php или html
        ########################################
#        location ~ \.php$ {
#        include snippets/fastcgi-php.conf;
#        fastcgi_split_path_info ^(.+\.php)(/.+)$;
#        if (!-f $document_root$fastcgi_script_name) {
#             return 404;
#     	}
	
	# Mitigate https://httpoxy.org/ vulnerabilities
#    		fastcgi_param HTTP_PROXY "";
#		include snippets/fastcgi-php.conf;
	# include the fastcgi_param setting
#    		include fastcgi_params;
	#
	#	# With php-fpm (or other unix sockets):
#		fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
       	#	fastcgi_index index;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
#	}


#default
# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}
#}
